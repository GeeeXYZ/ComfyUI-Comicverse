# ComicVerse v1.2 使用指南

## 新功能概览

### 1. Prompt Rolling 节点改进

#### Weight 控件正确排列
现在所有 weight 控件都会按顺序向下排列，不再出现覆盖问题。

**使用方法**:
1. 添加 Prompt Rolling 节点
2. 连接第一个 Prompt Library Loader 到 `library_1`
3. 调整 `weight_1` 滑块（0.0-2.0，默认 1.0）
4. 添加更多 Loader，每个都会自动显示对应的 weight 控件
5. 所有 weight 控件按顺序显示：seed → weight_1 → weight_2 → weight_3...

**示例**:
```
Prompt Library Loader (camera) → library_1 (weight_1: 1.2)
Prompt Library Loader (lighting) → library_2 (weight_2: 1.5)
Prompt Library Loader (style) → library_3 (weight_3: 0.8)
```

输出示例: `(low angle, 35mm:1.2), (soft lighting, golden hour:1.5), (cinematic:0.8)`

#### 自适应节点大小
节点会自动调整大小以适应所有内容。

**特性**:
- ✅ 添加新输入时自动增大
- ✅ 删除输入时自动缩小
- ✅ 最小尺寸：320x180 像素
- ✅ 用户可以手动调整，但不会小于最小尺寸
- ✅ 保存工作流后重新加载，尺寸保持正确

**最佳实践**:
- 让节点自动调整大小，无需手动调整
- 如果需要更大的节点，可以手动拖拽右下角
- 节点永远不会小到内容溢出

### 2. Text Preview 节点增强

#### 新增 STRING 输出
Text Preview 现在既可以预览文本，也可以将文本传递给下游节点。

**使用场景**:

**场景 1: 纯预览（原有功能）**
```
Prompt Rolling → Text Preview
```
- 查看生成的 prompt
- 不连接输出，仅用于调试

**场景 2: 预览 + 传递（新功能）**
```
Prompt Rolling → Text Preview → CLIP Text Encode
                      ↓
                  (显示预览)
```
- 在传递给 CLIP 之前预览 prompt
- 确认生成的内容正确
- 无需重复连接

**场景 3: 多路输出**
```
Prompt Rolling → Text Preview → CLIP Text Encode (正面提示词)
                      ↓
                 另一个 Text Preview → 其他节点
```
- 一个输入，多个输出
- 在多个地方使用相同的文本

#### 改进的多行显示

**特性**:
- ✅ 支持最多 25 行文本显示
- ✅ 最小 6 行，确保可读性
- ✅ 自动计算高度，无需手动调整
- ✅ 等宽字体（monospace），便于阅读
- ✅ 自动换行，长行不会被截断

**显示效果**:
```
┌─────────────────────────────┐
│ Text Preview (Comic)        │
├─────────────────────────────┤
│ text (输入)                  │
│                             │
│ ┌─────────────────────────┐ │
│ │ (low angle, 35mm:1.2),  │ │
│ │ (soft lighting:1.5),    │ │
│ │ cinematic, dramatic,    │ │
│ │ high contrast           │ │
│ │                         │ │
│ │                         │ │
│ └─────────────────────────┘ │
│                             │
│ text (输出) ○               │
└─────────────────────────────┘
```

#### 自适应大小
- 最小尺寸：400x200 像素
- 根据文本行数自动调整高度
- 短文本：紧凑显示
- 长文本：自动增高（最多 25 行）
- 超长文本：显示滚动条

## 完整工作流示例

### 示例 1: 基础 Prompt 生成 + 预览
```
┌─────────────────────┐
│ Prompt Library      │
│ Loader (camera)     │
└──────┬──────────────┘
       │
       ├─────────────────────┐
       │                     │
┌──────▼──────────────┐      │
│ Prompt Rolling      │      │
│ - seed: 42          │      │
│ - weight_1: 1.2     │      │
└──────┬──────────────┘      │
       │                     │
┌──────▼──────────────┐      │
│ Text Preview        │      │
│ (查看生成的 prompt)  │      │
└─────────────────────┘      │
                             │
┌────────────────────────────▼┐
│ Prompt Library              │
│ Loader (lighting)           │
└─────────────────────────────┘
```

### 示例 2: 多库组合 + 预览 + 生成
```
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Loader       │  │ Loader       │  │ Loader       │
│ (camera)     │  │ (lighting)   │  │ (style)      │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │
       └────────┬────────┴────────┬────────┘
                │                 │
         ┌──────▼─────────────────▼──────┐
         │ Prompt Rolling                │
         │ - seed: -1 (随机)             │
         │ - weight_1: 1.2               │
         │ - weight_2: 1.5               │
         │ - weight_3: 0.8               │
         └──────┬────────────────────────┘
                │
         ┌──────▼────────────────────────┐
         │ Text Preview                  │
         │ (预览组合后的 prompt)          │
         └──────┬────────────────────────┘
                │
         ┌──────▼────────────────────────┐
         │ CLIP Text Encode              │
         └──────┬────────────────────────┘
                │
         ┌──────▼────────────────────────┐
         │ KSampler / 其他生成节点        │
         └───────────────────────────────┘
```

### 示例 3: 调试工作流
```
┌──────────────┐
│ Prompt       │
│ Rolling      │
└──────┬───────┘
       │
       ├─────────────────┬─────────────────┐
       │                 │                 │
┌──────▼───────┐  ┌──────▼───────┐  ┌──────▼───────┐
│ Text Preview │  │ Text Preview │  │ Text Preview │
│ (原始)       │  │ (备份1)      │  │ (备份2)      │
└──────────────┘  └──────┬───────┘  └──────┬───────┘
                         │                 │
                  ┌──────▼───────┐  ┌──────▼───────┐
                  │ CLIP Encode  │  │ 保存到文件   │
                  └──────────────┘  └──────────────┘
```

## 常见问题

### Q1: Weight 控件还是会重叠怎么办？
A: 这个问题已经在 v1.2 中修复。如果仍然出现：
1. 删除节点，重新添加
2. 确保使用的是最新版本
3. 重启 ComfyUI

### Q2: Text Preview 的输出必须连接吗？
A: 不必须。Text Preview 保持 `OUTPUT_NODE` 属性，即使不连接输出也会执行和显示。输出是可选的。

### Q3: 节点太小，内容显示不全？
A: v1.2 已经修复此问题。节点会自动调整到合适的大小。如果问题仍然存在：
1. 手动拖拽节点右下角放大
2. 节点会记住你设置的大小
3. 最小尺寸会根据内容自动调整

### Q4: Text Preview 能显示多长的文本？
A: 
- 显示区域最多 25 行
- 超过 25 行会显示滚动条
- 输出没有长度限制，完整传递所有文本

### Q5: 如何固定 Prompt Rolling 的随机结果？
A: 设置 `seed` 为固定值（如 42）。相同的 seed + 相同的输入 = 相同的输出。

## 性能提示

1. **Prompt Rolling**: 
   - 最多支持 8 个输入
   - 建议 3-5 个输入以保持可读性
   - Weight 建议范围：0.5-1.5

2. **Text Preview**:
   - 纯显示节点，性能开销极小
   - 可以添加多个用于不同的预览
   - 输出是直接传递，无额外计算

## 升级说明

从 v1.1 升级到 v1.2：
- ✅ 完全向后兼容
- ✅ 现有工作流无需修改
- ✅ Text Preview 的新输出是可选的
- ✅ 节点大小会自动调整，无需手动修改

## 技术支持

遇到问题？
1. 查看 `OPTIMIZATION_NOTES.md` 了解技术细节
2. 运行测试：`pytest tests/test_prompt_nodes.py`
3. 提交 Issue 到 GitHub

